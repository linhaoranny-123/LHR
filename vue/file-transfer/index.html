<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡ä»¶ä¸Šä¼ ç³»ç»Ÿ - è°ƒè¯•æ¨¡å¼</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <link rel="stylesheet" href="style.css">
    <style>
        .debug-info {
            background-color: #f5f5f5;
            border: 1px solid #ddd;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .debug-controls {
            margin: 10px 0;
            padding: 10px;
            background-color: #e8f4f8;
            border-radius: 5px;
        }
        
        .error-details {
            color: #d32f2f;
            background-color: #ffebee;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .alert {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        
        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="container">
            <!-- è°ƒè¯•æ§åˆ¶é¢æ¿ -->
            <div class="debug-controls">
                <h3>è°ƒè¯•é¢æ¿</h3>
                <div>
                    <label>
                        <input type="checkbox" v-model="debugMode"> å¯ç”¨è°ƒè¯•æ¨¡å¼
                    </label>
                    <button @click="clearDebugLogs" class="btn btn-secondary" style="margin-left: 10px;">
                        æ¸…é™¤æ—¥å¿—
                    </button>
                    <button @click="testGatewayConnection" class="btn" style="margin-left: 10px;">
                        æµ‹è¯•ç½‘å…³è¿æ¥
                    </button>
                    <button @click="testDirectConnection" class="btn" style="margin-left: 10px;">
                        æµ‹è¯•ç›´æ¥è¿æ¥
                    </button>
                </div>
                
                <div style="margin-top: 10px;">
                    <label>APIåœ°å€:</label>
                    <input type="text" v-model="apiBase" style="width: 300px; margin-left: 10px;">
                    <button @click="updateApiBase" class="btn" style="margin-left: 10px;">
                        æ›´æ–°
                    </button>
                </div>
            </div>
            
            <!-- è°ƒè¯•ä¿¡æ¯ -->
            <div v-if="debugMode" class="debug-info">
                <div v-for="(log, index) in debugLogs" :key="index">
                    [{{ log.timestamp }}] {{ log.message }}
                </div>
            </div>
            
            <!-- é”™è¯¯è¯¦æƒ… -->
            <div v-if="errorDetails" class="error-details">
                <strong>é”™è¯¯è¯¦æƒ…:</strong> {{ errorDetails }}
            </div>
            
            <!-- æ¶ˆæ¯æç¤º -->
            <div v-if="message" class="alert" :class="messageType">
                {{ message }}
            </div>
            
            <!-- åŸæ¥çš„ç•Œé¢å†…å®¹ -->
            <div class="header">
                <h1>æ–‡ä»¶ä¸Šä¼ ç³»ç»Ÿ</h1>
                <p>æ”¯æŒä¸Šä¼ æœ€å¤§1GBçš„æ–‡ä»¶ï¼Œæ–‡ä»¶ä¿å­˜7å¤©åè‡ªåŠ¨åˆ é™¤</p>
            </div>
            
            <div class="content">
                <div class="form-group">
                    <label for="token">èº«ä»½éªŒè¯ Token</label>
                    <input 
                        type="text" 
                        id="token" 
                        v-model="token" 
                        placeholder="è¯·è¾“å…¥æ‚¨çš„èº«ä»½éªŒè¯ Token"
                        @input="clearMessages"
                    >
                </div>
                
                <div 
                    class="upload-area" 
                    :class="{ 'dragover': isDragging }"
                    @click="triggerFileInput"
                    @drop="handleDrop"
                    @dragover.prevent="isDragging = true"
                    @dragleave="isDragging = false"
                >
                    <i>ğŸ“</i>
                    <h3>ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„ä¸Šä¼ </h3>
                    <p>æ”¯æŒå•ä¸ªæ–‡ä»¶ä¸Šä¼ ï¼Œæœ€å¤§1GB</p>
                    <input 
                        type="file" 
                        ref="fileInput" 
                        @change="handleFileSelect" 
                        style="display: none"
                    >
                </div>
                
                <div v-if="selectedFile" class="file-info">
                    <h4>å·²é€‰æ‹©æ–‡ä»¶</h4>
                    <p><strong>æ–‡ä»¶å:</strong> {{ selectedFile.name }}</p>
                    <p><strong>æ–‡ä»¶å¤§å°:</strong> {{ formatFileSize(selectedFile.size) }}</p>
                    <p><strong>æ–‡ä»¶ç±»å‹:</strong> {{ selectedFile.type || 'æœªçŸ¥' }}</p>
                </div>
                
                <div v-if="uploadProgress > 0" class="progress">
                    <div class="progress-bar" :style="{ width: uploadProgress + '%' }"></div>
                </div>
                
                <div class="actions">
                    <button 
                        class="btn" 
                        @click="uploadFile" 
                        :disabled="!selectedFile || !token || uploading"
                    >
                        {{ uploading ? 'ä¸Šä¼ ä¸­...' : 'ä¸Šä¼ æ–‡ä»¶' }}
                    </button>
                    <button 
                        class="btn btn-secondary" 
                        @click="resetForm" 
                        :disabled="uploading"
                    >
                        é‡ç½®
                    </button>
                </div>
                
                <div class="file-list">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h3>æ–‡ä»¶åˆ—è¡¨ (å…± {{ totalFiles }} ä¸ªæ–‡ä»¶)</h3>
                        <button class="btn refresh-btn" @click="fetchFileList" :disabled="loadingFileList">
                            {{ loadingFileList ? 'åŠ è½½ä¸­...' : 'åˆ·æ–°åˆ—è¡¨' }}
                        </button>
                    </div>
                    
                    <div v-if="loadingFileList" class="empty-state">
                        <p>æ­£åœ¨åŠ è½½æ–‡ä»¶åˆ—è¡¨...</p>
                    </div>
                    <div v-else-if="displayedFiles.length > 0">
                        <div class="file-item" v-for="file in displayedFiles" :key="file.fileName">
                            <div>
                                <div class="file-name">{{ file.fileName }}</div>
                                <div class="file-size">{{ formatFileSize(file.fileSize) }}</div>
                            </div>
                            <div class="actions">
                                <button class="icon-btn" @click="downloadFile(file)" title="ä¸‹è½½">â¬‡ï¸</button>
                                <button class="icon-btn delete-btn" @click="deleteFile(file)" title="åˆ é™¤">ğŸ—‘ï¸</button>
                            </div>
                        </div>
                    </div>
                    <div v-else class="empty-state">
                        <i>ğŸ“„</i>
                        <p>æš‚æ— æ–‡ä»¶</p>
                    </div>
                </div>
            </div>
            
            <div class="footer">
                <p>æ–‡ä»¶ä¸Šä¼ ç³»ç»Ÿ &copy; 2025 - æ–‡ä»¶å°†åœ¨7å¤©åè‡ªåŠ¨åˆ é™¤</p>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, onMounted, computed } = Vue;
        
        createApp({
            setup() {
                const token = ref('fk521314');
                const selectedFile = ref(null);
                const fileList = ref([]);
                const uploading = ref(false);
                const uploadProgress = ref(0);
                const message = ref('');
                const messageType = ref('');
                const isDragging = ref(false);
                const fileInput = ref(null);
                const loadingFileList = ref(false);
                
                // è°ƒè¯•ç›¸å…³
                const debugMode = ref(true);
                const debugLogs = ref([]);
                const errorDetails = ref('');
                const apiBase = ref('http://192.168.1.200:8088');
                
                // åˆ†é¡µç›¸å…³
                const currentPage = ref(1);
                const pageSize = ref(5);
                
                // è®¡ç®—å±æ€§
                const totalFiles = computed(() => fileList.value.length);
                const totalPages = computed(() => Math.ceil(totalFiles.value / pageSize.value));
                const displayedFiles = computed(() => {
                    const startIndex = (currentPage.value - 1) * pageSize.value;
                    const endIndex = startIndex + pageSize.value;
                    return fileList.value.slice(startIndex, endIndex);
                });
                
                // è°ƒè¯•å‡½æ•°
                const addDebugLog = (msg) => {
                    const timestamp = new Date().toLocaleTimeString();
                    debugLogs.value.push({
                        timestamp: timestamp,
                        message: msg
                    });
                    console.log(`[${timestamp}] ${msg}`);
                };
                
                const clearDebugLogs = () => {
                    debugLogs.value = [];
                    errorDetails.value = '';
                };
                
                const updateApiBase = () => {
                    addDebugLog(`APIåœ°å€å·²æ›´æ–°ä¸º: ${apiBase.value}`);
                    localStorage.setItem('apiBase', apiBase.value);
                };
                
                // æ¶ˆæ¯å‡½æ•°
                const showMessage = (text, type) => {
                    message.value = text;
                    messageType.value = type === 'success' ? 'alert-success' : 'alert-error';
                    
                    setTimeout(() => {
                        clearMessages();
                    }, 5000);
                };
                
                const clearMessages = () => {
                    message.value = '';
                    messageType.value = '';
                };
                
                // æµ‹è¯•è¿æ¥å‡½æ•°
                const testGatewayConnection = async () => {
                    addDebugLog(`å¼€å§‹æµ‹è¯•ç½‘å…³è¿æ¥: ${apiBase.value}`);
                    
                    try {
                        // æµ‹è¯•ç½‘å…³è‡ªèº«
                        const response = await fetch(`${apiBase.value}/gateway/health`, {
                            method: 'GET',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        addDebugLog(`ç½‘å…³æµ‹è¯•å“åº”çŠ¶æ€: ${response.status}`);
                        
                        if (response.ok) {
                            const result = await response.json();
                            addDebugLog(`ç½‘å…³æµ‹è¯•æˆåŠŸ: ${JSON.stringify(result)}`);
                            showMessage('ç½‘å…³è¿æ¥æµ‹è¯•æˆåŠŸ', 'success');
                        } else {
                            addDebugLog(`ç½‘å…³æµ‹è¯•å¤±è´¥: ${response.status} ${response.statusText}`);
                            showMessage(`ç½‘å…³è¿æ¥å¤±è´¥: ${response.status}`, 'error');
                        }
                        
                    } catch (error) {
                        addDebugLog(`æµ‹è¯•è¿æ¥æ—¶å‘ç”Ÿå¼‚å¸¸: ${error.message}`);
                        errorDetails.value = error.message;
                        showMessage(`è¿æ¥æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                    }
                };
                
                const testDirectConnection = async () => {
                    const directUrl = 'http://192.168.1.200:8081';
                    addDebugLog(`æµ‹è¯•ç›´æ¥è¿æ¥: ${directUrl}`);
                    
                    try {
                        const response = await fetch(`${directUrl}/api/fileList`, {
                            method: 'GET',
                            headers: {
                                'Authorization': token.value,
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        addDebugLog(`ç›´æ¥è¿æ¥å“åº”çŠ¶æ€: ${response.status}`);
                        
                        if (response.ok) {
                            const result = await response.json();
                            addDebugLog(`ç›´æ¥è¿æ¥æˆåŠŸ: ${JSON.stringify(result).substring(0, 200)}...`);
                            showMessage('ç›´æ¥è¿æ¥æµ‹è¯•æˆåŠŸ', 'success');
                        } else {
                            addDebugLog(`ç›´æ¥è¿æ¥å¤±è´¥: ${response.status} ${response.statusText}`);
                            showMessage(`ç›´æ¥è¿æ¥å¤±è´¥: ${response.status}`, 'error');
                        }
                    } catch (error) {
                        addDebugLog(`ç›´æ¥è¿æ¥å¼‚å¸¸: ${error.message}`);
                        errorDetails.value = `ç›´æ¥è¿æ¥é”™è¯¯: ${error.message}`;
                        showMessage(`ç›´æ¥è¿æ¥æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                    }
                };
                
                // æ–‡ä»¶æ“ä½œå‡½æ•°
                const fetchFileList = async () => {
                    if (!token.value) {
                        showMessage('è¯·è¾“å…¥èº«ä»½éªŒè¯ Token', 'error');
                        return;
                    }
                    
                    loadingFileList.value = true;
                    addDebugLog(`å¼€å§‹è·å–æ–‡ä»¶åˆ—è¡¨ï¼ŒURL: ${apiBase.value}/api/fileList`);
                    
                    try {
                        const startTime = Date.now();
                        
                        const response = await fetch(`${apiBase.value}/api/fileList`, {
                            method: 'GET',
                            headers: {
                                'Authorization': token.value,
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        const endTime = Date.now();
                        const duration = endTime - startTime;
                        
                        addDebugLog(`è¯·æ±‚å®Œæˆï¼ŒçŠ¶æ€ç : ${response.status}ï¼Œè€—æ—¶: ${duration}ms`);
                        
                        if (!response.ok) {
                            const errorText = await response.text();
                            addDebugLog(`HTTPé”™è¯¯å“åº”: ${errorText}`);
                            errorDetails.value = `HTTP ${response.status}: ${errorText}`;
                            throw new Error(`HTTP error! status: ${response.status}, body: ${errorText}`);
                        }
                        
                        const result = await response.json();
                        addDebugLog(`å“åº”æ•°æ®: ${JSON.stringify(result).substring(0, 300)}...`);
                        
                        if (result.success && result.data) {
                            fileList.value = result.data;
                            addDebugLog(`æˆåŠŸåŠ è½½ ${result.data.length} ä¸ªæ–‡ä»¶`);
                            showMessage('æ–‡ä»¶åˆ—è¡¨åŠ è½½æˆåŠŸ', 'success');
                        } else {
                            addDebugLog(`å“åº”æ ¼å¼ä¸ç¬¦åˆé¢„æœŸ: ${JSON.stringify(result)}`);
                            fileList.value = [];
                            showMessage('æ–‡ä»¶åˆ—è¡¨åŠ è½½å¤±è´¥', 'error');
                        }
                    } catch (error) {
                        console.error('è·å–æ–‡ä»¶åˆ—è¡¨å¤±è´¥:', error);
                        addDebugLog(`è·å–æ–‡ä»¶åˆ—è¡¨å¼‚å¸¸: ${error.message}`);
                        errorDetails.value = `è·å–æ–‡ä»¶åˆ—è¡¨å¤±è´¥: ${error.message}`;
                        showMessage(`è·å–æ–‡ä»¶åˆ—è¡¨å¤±è´¥: ${error.message}`, 'error');
                        fileList.value = [];
                    } finally {
                        loadingFileList.value = false;
                    }
                };
                
                // å…¶ä»–æ–‡ä»¶æ“ä½œå‡½æ•°ï¼ˆuploadFile, downloadFile, deleteFileç­‰ï¼‰
                // æš‚æ—¶çœç•¥ï¼Œå…ˆæµ‹è¯•åŸºæœ¬åŠŸèƒ½
                
                const triggerFileInput = () => {
                    fileInput.value.click();
                };
                
                const handleFileSelect = (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        if (file.size > 1073741824) {
                            showMessage('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡1GB', 'error');
                            return;
                        }
                        selectedFile.value = file;
                        clearMessages();
                    }
                };
                
                const handleDrop = (event) => {
                    event.preventDefault();
                    isDragging.value = false;
                    
                    const files = event.dataTransfer.files;
                    if (files.length > 0) {
                        const file = files[0];
                        if (file.size > 1073741824) {
                            showMessage('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡1GB', 'error');
                            return;
                        }
                        selectedFile.value = file;
                        clearMessages();
                    }
                };
                
                const uploadFile = async () => {
                    if (!selectedFile.value) {
                        showMessage('è¯·é€‰æ‹©è¦ä¸Šä¼ çš„æ–‡ä»¶', 'error');
                        return;
                    }
                    
                    if (!token.value) {
                        showMessage('è¯·è¾“å…¥èº«ä»½éªŒè¯ Token', 'error');
                        return;
                    }
                    
                    uploading.value = true;
                    uploadProgress.value = 0;
                    
                    try {
                        const formData = new FormData();
                        formData.append('file', selectedFile.value);
                        formData.append('token', token.value);
                        
                        const progressInterval = setInterval(() => {
                            if (uploadProgress.value < 90) {
                                uploadProgress.value += 10;
                            }
                        }, 200);
                        
                        const response = await fetch(`${apiBase.value}/api/upload`, {
                            method: 'POST',
                            body: formData
                        });
                        
                        clearInterval(progressInterval);
                        uploadProgress.value = 100;
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            showMessage(`æ–‡ä»¶ä¸Šä¼ æˆåŠŸ: ${result.data}`, 'success');
                            await fetchFileList();
                            selectedFile.value = null;
                            if (fileInput.value) {
                                fileInput.value.value = '';
                            }
                        } else {
                            showMessage(`ä¸Šä¼ å¤±è´¥: ${result.message}`, 'error');
                        }
                    } catch (error) {
                        showMessage(`ä¸Šä¼ å¤±è´¥: ${error.message}`, 'error');
                    } finally {
                        uploading.value = false;
                        setTimeout(() => {
                            uploadProgress.value = 0;
                        }, 2000);
                    }
                };
                
                const downloadFile = async (file) => {
                    if (!token.value) {
                        showMessage('è¯·è¾“å…¥èº«ä»½éªŒè¯ Token', 'error');
                        return;
                    }
                    
                    try {
                        const downloadUrl = `${apiBase.value}/api/download?fileName=${encodeURIComponent(file.fileName)}&token=${encodeURIComponent(token.value)}`;
                        addDebugLog(`ä¸‹è½½æ–‡ä»¶: ${downloadUrl}`);
                        
                        const a = document.createElement('a');
                        a.href = downloadUrl;
                        a.download = file.fileName;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        
                        showMessage(`å¼€å§‹ä¸‹è½½: ${file.fileName}`, 'success');
                    } catch (error) {
                        console.error('ä¸‹è½½å¤±è´¥:', error);
                        showMessage(`ä¸‹è½½å¤±è´¥: ${error.message}`, 'error');
                    }
                };
                
                const deleteFile = async (file) => {
                    try {
                        const response = await fetch(`${apiBase.value}/api/delete?fileName=${file.fileName}`, {
                            method: 'DELETE',
                            headers: {
                                'Authorization': token.value
                            }
                        });
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            showMessage(`æ–‡ä»¶ "${file.fileName}" å·²åˆ é™¤`, 'success');
                            await fetchFileList();
                        } else {
                            showMessage(`åˆ é™¤å¤±è´¥: ${result.message}`, 'error');
                        }
                    } catch (error) {
                        showMessage(`åˆ é™¤å¤±è´¥: ${error.message}`, 'error');
                    }
                };
                
                const resetForm = () => {
                    selectedFile.value = null;
                    if (fileInput.value) {
                        fileInput.value.value = '';
                    }
                    clearMessages();
                };
                
                const formatFileSize = (bytes) => {
                    if (typeof bytes === 'string') {
                        return bytes;
                    }
                    
                    if (bytes === 0) return '0 Bytes';
                    
                    const k = 1024;
                    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
                };
                
                // åˆå§‹åŒ–
                onMounted(() => {
                    addDebugLog('Vueåº”ç”¨å·²æŒ‚è½½');
                    
                    const savedApiBase = localStorage.getItem('apiBase');
                    if (savedApiBase) {
                        apiBase.value = savedApiBase;
                        addDebugLog(`ä»æœ¬åœ°å­˜å‚¨åŠ è½½APIåœ°å€: ${savedApiBase}`);
                    }
                    
                    const savedToken = localStorage.getItem('uploadToken');
                    if (savedToken) {
                        token.value = savedToken;
                    }
                    
                    const tokenInput = document.getElementById('token');
                    if (tokenInput) {
                        tokenInput.addEventListener('input', () => {
                            localStorage.setItem('uploadToken', token.value);
                        });
                    }
                    
                    // é¡µé¢åŠ è½½æ—¶è·å–æ–‡ä»¶åˆ—è¡¨
                    fetchFileList();
                });
                
                return {
                    // åŸæœ‰å˜é‡
                    token,
                    selectedFile,
                    fileList,
                    uploading,
                    uploadProgress,
                    message,
                    messageType,
                    isDragging,
                    fileInput,
                    loadingFileList,
                    currentPage,
                    pageSize,
                    totalFiles,
                    totalPages,
                    displayedFiles,
                    
                    // è°ƒè¯•å˜é‡
                    debugMode,
                    debugLogs,
                    errorDetails,
                    apiBase,
                    
                    // æ–¹æ³•
                    showMessage,
                    clearMessages,
                    fetchFileList,
                    triggerFileInput,
                    handleFileSelect,
                    handleDrop,
                    uploadFile,
                    downloadFile,
                    deleteFile,
                    resetForm,
                    formatFileSize,
                    clearDebugLogs,
                    testGatewayConnection,
                    testDirectConnection,
                    updateApiBase
                };
            }
        }).mount('#app');
    </script>
</body>
</html>